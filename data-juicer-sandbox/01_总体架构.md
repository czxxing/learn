


## 项目概述

**data-juicer-sandbox** 是一个反馈驱动的多模态数据-模型协同开发套件，基于 py-data-juicer 构建，提供了一个沙箱环境用于数据和模型的协同优化与开发。

## 核心组件

### 1. 命令行入口 (cli/sandbox_starter.py)
- 提供命令行接口，解析配置文件和参数
- 初始化沙箱执行器并启动运行
- 支持实验配置、迭代目标设置等功能

### 2. 上下文信息管理 (context_infos.py)
- `JobInfos`：记录单个作业的元信息和输出结果
- `PipelineInfos`：管理管道中所有作业的信息
- `ContextInfos`：记录当前迭代的上下文信息
- `GlobalContextInfos`：管理全局的上下文信息历史

### 3. 管道系统 (pipelines.py)
- `SandBoxWatcher`：使用 WandB 进行实验监控和日志记录
- `Target`：定义迭代目标条件（如指标阈值）
- `SandboxPipeline`：核心管道类，包含四种作业类型：
  - **probe jobs**：数据探测与分析
  - **refine_recipe jobs**：数据处理流程优化
  - **execution jobs**：模型训练或推理执行
  - **evaluation jobs**：结果评估与反馈

### 4. 钩子机制 (hooks.py)
- `BaseHook`：所有钩子的基类，提供通用功能
  - 输入更新：根据上下文信息更新配置
  - 钩子执行：调用具体的钩子实现
  - 输出记录：将结果记录到上下文信息中
- 支持配置参数的动态更新和结果的链式传递

### 5. 工厂模式 (factories.py)
提供各种组件的工厂方法，支持灵活扩展：
- 数据执行器工厂
- 数据分析器工厂
- 数据评估器工厂
- 模型执行器工厂
- 数据池操作器工厂

### 6. 模型执行器 (model_executors.py)
- `BaseModelExecutor`：模型执行器基类
- `ModelscopeInferProbeExecutor`：模型推理执行器
- `ModelscopeTrainExecutor`：模型训练执行器

### 7. 评估器 (evaluators.py)
- `BaseEvaluator`：评估器基类
- `Gpt3QualityEvaluator`：数据质量评估器
- `InceptionEvaluator`：生成数据质量评估器
- `AccuracyEvaluator`：预测准确率评估器
- `MSEEvaluator`：均方误差评估器

### 8. 数据池操作器
提供数据池的各种操作：
- 构建、组合、复制
- 下采样、合并、排序

## 工作流程

1. **配置解析**：通过命令行或配置文件定义实验参数
2. **管道初始化**：创建沙箱管道，加载作业配置
3. **作业执行**：按顺序执行管道中的各类作业
   - 探测数据特征
   - 优化数据处理流程
   - 执行模型训练或推理
   - 评估结果
4. **上下文管理**：记录作业结果到上下文信息
5. **迭代优化**：根据评估结果和目标条件，决定是否进行下一轮迭代
6. **实验监控**：使用 WandB 记录和可视化实验过程与结果

## 架构特点

1. **模块化设计**：各组件职责明确，便于维护和扩展
2. **钩子机制**：提供灵活的扩展点，支持自定义作业
3. **迭代优化**：支持基于反馈的迭代式数据-模型协同开发
4. **多模态支持**：兼容文本、图像、视频等多种数据类型
5. **实验可追溯**：通过 WandB 和上下文信息实现实验的可追溯性
6. **工厂模式**：使用工厂模式实现组件的灵活创建和扩展

## 技术栈

- **核心框架**：py-data-juicer
- **深度学习**：PyTorch
- **分布式计算**：PySpark
- **实验管理**：WandB
- **命令行工具**：Fire
- **配置管理**：jsonargparse、YAML

这个架构设计支持数据和模型的协同优化，通过反馈机制实现数据处理流程和模型性能的迭代提升，适用于多模态数据的模型开发场景。
        